{% extends "base.html" %}

{% block title %}Travel Mind - Twój Inteligentny Asystent Podróży{% endblock %}

{% block content %}
    <div class="hero-section">
        <div class="container">
            <h1><span class="icon">✈️</span> Travel Mind</h1>
            <p>Wpisz swój cel podróży, a my wygenerujemy spersonalizowany plan, pogodę i szacowany budżet.</p>
            
            <form method="POST" action="">
                {{ form.hidden_tag() }}
                
                <div class="form-group" style="position:relative;">
                    {{ form.city.label }}
                    {{ form.city(class="form-control", placeholder="np. Kraków, Rzym lub Tatry", id="city-input") }}
                    <!-- kontener sugestii -->
                    <div id="city-suggestions" class="suggestions" style="position:absolute;left:0;right:0;z-index:30;background:#fff;border:1px solid #ddd;border-radius:6px;display:none;max-height:220px;overflow:auto;"></div>
                    <!-- ukryte pola z koordynatami (wypełniane przez autocomplete) -->
                    <input type="hidden" name="city_lat" id="city-lat">
                    <input type="hidden" name="city_lon" id="city-lon">
                </div>
                <div class="form-group">
                    {{ form.start_date.label }}
                    {{ form.start_date(class="form-control", type="date", id="start_date") }}
                </div>
                <div class="form-group">
                    {{ form.end_date.label }}
                    {{ form.end_date(class="form-control", type="date", id="end_date") }}
                </div>

                <div class="form-group">
                    <label for="datepicker">Wybierz zakres dat (nowy kalendarz)</label>
                    <input id="datepicker" class="form-control"/>
                </div>

                <div class="form-group">
                    <small id="days-info" class="form-text text-muted"></small>
                    <div id="date-error" class="text-danger" role="alert" aria-live="polite"></div>
                </div>
                <div class="form-group">
                    {{ form.travel_style.label }}
                    {{ form.travel_style(class="form-control") }}
                </div>
                
                {{ form.submit(class="btn btn-primary", id="submit-btn") }}
            </form>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const maxDate = new Date();
            maxDate.setDate(maxDate.getDate() + 45);

            // Inicjalizacja nowego kalendarza Litepicker
            new Litepicker({ 
                element: document.getElementById('datepicker'),
                singleMode: false,
                allowRepick: true,
                lang: 'pl-PL',
                format: 'DD.MM.YYYY',
                minDate: Date.now(),
                maxDate: maxDate,
                maxDays: 14,
                setup: (picker) => {
                    picker.on('selected', (date1, date2) => {
                        // Tutaj w przyszłości podepniemy logikę
                        console.log('Wybrano zakres:', date1.dateInstance, 'do', date2.dateInstance);
                    });
                }
            });

            // Autocomplete dla pola miasta (wywołuje /api/geocode)
            const cityInput = document.getElementById('city-input');
            const suggestionsEl = document.getElementById('city-suggestions');
            const cityLatEl = document.getElementById('city-lat');
            const cityLonEl = document.getElementById('city-lon');

            let acTimer = null;
            function clearSuggestions(){ suggestionsEl.innerHTML=''; suggestionsEl.style.display='none'; }
            function renderSuggestions(items){
                if(!items || !items.length){ clearSuggestions(); return; }
                suggestionsEl.innerHTML = '';
                items.forEach(it => {
                    const el = document.createElement('div');
                    el.className = 'suggestion-item';
                    el.style.padding = '8px 10px';
                    el.style.cursor = 'pointer';
                    el.textContent = it.name;
                    el.dataset.lat = it.lat;
                    el.dataset.lon = it.lon;
                    el.addEventListener('click', () => {
                        cityInput.value = it.name;
                        cityLatEl.value = it.lat;
                        cityLonEl.value = it.lon;
                        clearSuggestions();
                    });
                    suggestionsEl.appendChild(el);
                });
                suggestionsEl.style.display = 'block';
            }

            cityInput && cityInput.addEventListener('input', (e)=>{
                cityLatEl.value = '';
                cityLonEl.value = '';
                const q = (e.target.value || '').trim();
                if(acTimer) clearTimeout(acTimer);
                if(!q || q.length < 2){ clearSuggestions(); return; }
                acTimer = setTimeout(()=>{
                    fetch(`/api/geocode?q=${encodeURIComponent(q)}`)
                        .then(r => r.json())
                        .then(data => renderSuggestions(data))
                        .catch(()=> clearSuggestions());
                }, 250);
            });
            document.addEventListener('click', (ev)=>{ if(!ev.target.closest('#city-suggestions') && ev.target !== cityInput) clearSuggestions(); });

            const start = document.getElementById('start_date');
            const end = document.getElementById('end_date');
            const info = document.getElementById('days-info');
            const error = document.getElementById('date-error');
            const submit = document.getElementById('submit-btn');

            const maxDateForInputs = new Date();
            maxDateForInputs.setDate(maxDateForInputs.getDate() + 45);
            const maxDateString = maxDateForInputs.toISOString().split('T')[0];
            if (start) start.max = maxDateString;
            if (end) end.max = maxDateString;

            function updateInfo() {
                if (!start || !end || !info || !error || !submit) return;
                const sVal = start.value;
                const eVal = end.value;
                if (sVal && eVal) {
                    const s = new Date(sVal);
                    const e = new Date(eVal);
                    const diffMs = e - s;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    const days = diffDays >= 0 ? diffDays + 1 : 0;
                    if (days <= 0) {
                        info.textContent = '';
                        error.textContent = 'Data powrotu musi być po dacie wyjazdu.';
                        submit.disabled = true;
                    } else if (days > 14) {
                        info.textContent = `Wybrano ${days} dni`;
                        error.textContent = 'Maksymalny dozwolony przedział to 14 dni.';
                        submit.disabled = true;
                    } else {
                        info.textContent = `Wybrano ${days} dni`;
                        error.textContent = '';
                        submit.disabled = false;
                    }
                    // set minimum for end date to help user
                    end.min = sVal;
                } else {
                    info.textContent = '';
                    error.textContent = '';
                    submit.disabled = false;
                    // reset min
                    end.min = '';
                }
            }

            start && start.addEventListener('change', updateInfo);
            end && end.addEventListener('change', updateInfo);
            
            updateInfo();
        });
    </script>
{% endblock %}