{% extends "base.html" %}

{% block title %}Travel Mind - Tw√≥j Inteligentny Asystent Podr√≥≈ºy{% endblock %}

{% block content %}
    <!-- Mapa w tle -->
    <div id="map-background"></div>
    <div id="map-sidebar" class="hidden-panel">
        <button type="button" id="close-map-btn">X</button>
        <div id="active-map"></div>
        <button type="button" id="save-location-btn" class="btn btn-secondary">Zapisz i wr√≥ƒá do planu</button>
    </div>

    <div class="hero-section">
        <div class="container">
            <h1><span class="icon">‚úàÔ∏è</span> Travel Mind</h1>
            <p>Wpisz sw√≥j cel podr√≥≈ºy, a my wygenerujemy spersonalizowany plan, pogodƒô i szacowany bud≈ºet.</p>
            
            <form method="POST" action="">
                {{ form.hidden_tag() }}
                
                <!-- Sekcja wyboru klimatu (Kafelki) -->
                <div class="form-group">
                    <label class="form-label">Wybierz klimat podr√≥≈ºy (opcjonalnie):</label>
                    <div class="vibes-container">
                        {% for subfield in form.vibes %}
                        <div class="vibe-item">
                            {{ subfield(class="vibe-checkbox") }}
                            <label for="{{ subfield.id }}" class="vibe-card">
                                <span class="vibe-icon">
                                    {% if subfield.data == 'beach_sun' %}<div class="icon">üèñÔ∏è</div>
                                    {% elif subfield.data == 'mountains_trekking' %}<div class="icon">üèîÔ∏è</div>
                                    {% elif subfield.data == 'city_break' %}<div class="icon">üèôÔ∏è</div>
                                    {% elif subfield.data == 'history_culture' %}<div class="icon">üèõÔ∏è</div>
                                    {% elif subfield.data == 'nature' %}<div class="icon">üå≤</div>
                                    {% elif subfield.data == 'nightlife_parties' %}<div class="icon">üéâ</div>
                                    {% else %}<div class="icon">‚ú®</div>{% endif %}
                                </span>
                                <span class="vibe-label">{{ subfield.label.text }}</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group" style="position:relative;">
                    <label for="city-input-combined">Wpisz **lub** wybierz konkretne miasto z mapy:</label>
                    
                    {{ form.city(class="form-control", placeholder="np. Krak√≥w, Rzym lub Tatry", id="city-input-combined") }}
                    
                    <button type="button" id="show-map-btn" class="btn btn-secondary" style="width:100%; margin-top: 5px;">
                        Wybierz Lokalizacjƒô na Mapie üó∫Ô∏è
                    </button>
                    
                    <div id="city-suggestions" class="suggestions" style="position:absolute;left:0;right:0;z-index:30;background:#fff;border:1px solid #ddd;border-radius:6px;display:none;max-height:220px;overflow:auto;"></div>
                    
                    <input type="hidden" name="city_lat" id="city-lat">
                    <input type="hidden" name="city_lon" id="city-lon">
                </div>
                <div class="form-group">
                    {{ form.date_range.label(for="date_range_picker") }}
                    {{ form.date_range(class="form-control", id="date_range_picker", placeholder="Wybierz datƒô poczƒÖtkowƒÖ i ko≈ÑcowƒÖ") }}
                    {% if form.date_range.errors %}
                        <div class="text-danger" style="font-size: 0.875em; margin-top: 0.25rem;">
                            {% for error in form.date_range.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <small id="days-info" class="form-text text-muted"></small>
                    <div id="date-error" class="text-danger" role="alert" aria-live="polite"></div>
                </div>
                <div class="form-group">
                    {{ form.travel_style.label }}
                    {{ form.travel_style(class="form-control") }}
                </div>
                
                {{ form.submit(class="btn btn-primary", id="submit-btn") }}
            </form>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dateRangeInput = document.getElementById('date_range_picker');
            const infoEl = document.getElementById('days-info');
            const errorEl = document.getElementById('date-error');
            const submitBtn = document.getElementById('submit-btn');

            function updateDateInfo(startDate, endDate) {
                if (!startDate || !endDate) {
                    infoEl.textContent = '';
                    errorEl.textContent = '';
                    submitBtn.disabled = false;
                    return;
                }

                const diffMs = endDate - startDate;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const days = diffDays >= 0 ? diffDays + 1 : 0;

                if (days <= 0) {
                    infoEl.textContent = '';
                    errorEl.textContent = 'Data powrotu musi byƒá po dacie wyjazdu.';
                    submitBtn.disabled = true;
                } else if (days > 14) {
                    infoEl.textContent = `Wybrano ${days} dni`;
                    errorEl.textContent = 'Maksymalny dozwolony przedzia≈Ç to 14 dni.';
                    submitBtn.disabled = true;
                } else {
                    infoEl.textContent = `Wybrano ${days} dni`;
                    errorEl.textContent = '';
                    submitBtn.disabled = false;
                }
            }

            const maxDate = new Date();
            maxDate.setDate(maxDate.getDate() + 14);

            const picker = new Litepicker({ 
                element: dateRangeInput,
                singleMode: false,
                allowRepick: true,
                lang: 'pl-PL',
                format: 'YYYY-MM-DD',
                delimiter: ' - ',
                minDate: Date.now(),
                maxDate: maxDate,
                maxDays: 14,
                setup: (picker) => {
                    picker.on('selected', (date1, date2) => {
                        if (date1 && date2) {
                            updateDateInfo(date1.dateInstance, date2.dateInstance);
                        }
                    });
                    picker.on('clear:selection', () => {
                        updateDateInfo(null, null);
                    });
                }
            });

            // Autocomplete dla pola miasta (wywo≈Çuje /api/geocode)
            const cityInput = document.getElementById('city-input');
            const suggestionsEl = document.getElementById('city-suggestions');
            const cityLatEl = document.getElementById('city-lat');
            const cityLonEl = document.getElementById('city-lon');

            let acTimer = null;
            function clearSuggestions(){ suggestionsEl.innerHTML=''; suggestionsEl.style.display='none'; }
            function renderSuggestions(items){
                if(!items || !items.length){ clearSuggestions(); return; }
                suggestionsEl.innerHTML = '';
                items.forEach(it => {
                    const el = document.createElement('div');
                    el.className = 'suggestion-item';
                    el.style.padding = '8px 10px';
                    el.style.cursor = 'pointer';
                    el.textContent = it.name;
                    el.dataset.lat = it.lat;
                    el.dataset.lon = it.lon;
                    el.addEventListener('click', () => {
                        cityInput.value = it.name;
                        cityLatEl.value = it.lat;
                        cityLonEl.value = it.lon;
                        clearSuggestions();
                    });
                    suggestionsEl.appendChild(el);
                });
                suggestionsEl.style.display = 'block';
            }

            cityInput && cityInput.addEventListener('input', (e)=>{
                cityLatEl.value = '';
                cityLonEl.value = '';
                const q = (e.target.value || '').trim();
                if(acTimer) clearTimeout(acTimer);
                if(!q || q.length < 2){ clearSuggestions(); return; }
                acTimer = setTimeout(()=>{
                    fetch(`/api/geocode?q=${encodeURIComponent(q)}`)
                        .then(r => r.json())
                        .then(data => renderSuggestions(data))
                        .catch(()=> clearSuggestions());
                }, 250);
            });
            document.addEventListener('click', (ev)=>{ if(!ev.target.closest('#city-suggestions') && ev.target !== cityInput) clearSuggestions(); });

            // --- LOGIKA MAPY LEAFLET ---           
            let selectedMarker = null;
            let selectedCoords = null;
            let mapInitialized = false; 

            const mapSidebar = document.getElementById('map-sidebar');
            const showMapBtn = document.getElementById('show-map-btn');
            const saveBtn = document.getElementById('save-location-btn');
            const closeMapBtn = document.getElementById('close-map-btn');
            
            const NOMINATIM_API = 'https://nominatim.openstreetmap.org/reverse?format=json&lat=';

            // Mapa w Tle (Statyczna)
            const mapBackground = L.map('map-background', {
                zoomControl: false, 
                scrollWheelZoom: false,
                dragging: false,
                touchZoom: false,
                doubleClickZoom: false
            }).setView([30, 0], 2); 

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
                opacity: 0.7 
            }).addTo(mapBackground);

            // Aktywna Mapa 
            let activeMap;
            function initActiveMap() {
                if (mapInitialized) return;
                
                activeMap = L.map('active-map').setView([51.505, -0.09], 3); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(activeMap);
                
                activeMap.on('click', function(e) {
                    if (selectedMarker) {
                        activeMap.removeLayer(selectedMarker);
                    }
                    selectedCoords = e.latlng;
                    selectedMarker = L.marker(selectedCoords).addTo(activeMap);
                });

                mapInitialized = true;
            }

            // Geokodowanie Odwrotne (pobieranie nazwy miasta ze wsp√≥≈Çrzƒôdnych)
            async function reverseGeocode(lat, lon) {
                try {
                    const NOMINATIM_API = 'https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&extratags=1&lat=';
                    const response = await fetch(`${NOMINATIM_API}${lat}&lon=${lon}&zoom=14`);

                    const data = await response.json();
                    
                    let cityName = 'Wybrana Lokalizacja';
                    
                    if (data.address) {

                        cityName = data.address.city || data.address.town || data.address.village;
                        
                        if (!cityName) {
                            cityName = data.address.country || data.address.state;
                        }

                        if (cityName) {
                            return cityName;
                        }
                    }
                    // Je≈õli wszystko zawiedzie, u≈ºyj og√≥lnej nazwy z przybli≈ºonymi wsp√≥≈Çrzƒôdnymi
                    return `Wybrana lokalizacja (${lat.toFixed(2)}, ${lon.toFixed(2)})`;
                } catch (error) {
                    console.error('B≈ÇƒÖd geokodowania odwrotnego:', error);
                    return `Wsp√≥≈Çrzƒôdne: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                }
            }
            // Otwieranie bocznego panelu po klikniƒôciu przycisku
            showMapBtn && showMapBtn.addEventListener('click', function() {
                initActiveMap(); 
                mapSidebar.classList.add('active');
                setTimeout(() => {
                    activeMap.invalidateSize(); 
                }, 300); 
                clearSuggestions(); 
            });

           // Zapisanie wybranej lokalizacji i zamkniƒôcie panelu
            saveBtn && saveBtn.addEventListener('click', async function() {
                if (selectedCoords) {
                    const lat = selectedCoords.lat;
                    const lon = selectedCoords.lng;
                    
                    const cityName = await reverseGeocode(lat, lon);
                    
                    cityInput.value = cityName;
                    cityLatEl.value = lat;
                    cityLonEl.value = lon;
                }

                mapSidebar.classList.remove('active');
            });

            closeMapBtn && closeMapBtn.addEventListener('click', function() {
                mapSidebar.classList.remove('active');
            });
        });
    </script>
{% endblock %}