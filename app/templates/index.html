{% extends "base.html" %}

{% block title %}Travel Mind - Twój Inteligentny Asystent Podróży{% endblock %}

{% block content %}
    <div class="hero-section">
        <div class="container">
            <h1><span class="icon">✈️</span> Travel Mind</h1>
            <p>Wpisz swój cel podróży, a my wygenerujemy spersonalizowany plan, pogodę i szacowany budżet.</p>
            
            <form method="POST" action="">
                {{ form.hidden_tag() }}
                
                <div class="form-group" style="position:relative;">
                    {{ form.city.label }}
                    {{ form.city(class="form-control", placeholder="np. Kraków, Rzym lub Tatry", id="city-input") }}
                    <!-- kontener sugestii -->
                    <div id="city-suggestions" class="suggestions" style="position:absolute;left:0;right:0;z-index:30;background:#fff;border:1px solid #ddd;border-radius:6px;display:none;max-height:220px;overflow:auto;"></div>
                    <!-- ukryte pola z koordynatami (wypełniane przez autocomplete) -->
                    <input type="hidden" name="city_lat" id="city-lat">
                    <input type="hidden" name="city_lon" id="city-lon">
                </div>
                <div class="form-group">
                    {{ form.date_range.label(for="date_range_picker") }}
                    {{ form.date_range(class="form-control", id="date_range_picker", placeholder="Wybierz datę początkową i końcową") }}
                    {% if form.date_range.errors %}
                        <div class="text-danger" style="font-size: 0.875em; margin-top: 0.25rem;">
                            {% for error in form.date_range.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <small id="days-info" class="form-text text-muted"></small>
                    <div id="date-error" class="text-danger" role="alert" aria-live="polite"></div>
                </div>
                <div class="form-group">
                    {{ form.travel_style.label }}
                    {{ form.travel_style(class="form-control") }}
                </div>
                
                {{ form.submit(class="btn btn-primary", id="submit-btn") }}
            </form>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dateRangeInput = document.getElementById('date_range_picker');
            const infoEl = document.getElementById('days-info');
            const errorEl = document.getElementById('date-error');
            const submitBtn = document.getElementById('submit-btn');

            function updateDateInfo(startDate, endDate) {
                if (!startDate || !endDate) {
                    infoEl.textContent = '';
                    errorEl.textContent = '';
                    submitBtn.disabled = false;
                    return;
                }

                const diffMs = endDate - startDate;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const days = diffDays >= 0 ? diffDays + 1 : 0;

                if (days <= 0) {
                    infoEl.textContent = '';
                    errorEl.textContent = 'Data powrotu musi być po dacie wyjazdu.';
                    submitBtn.disabled = true;
                } else if (days > 14) {
                    infoEl.textContent = `Wybrano ${days} dni`;
                    errorEl.textContent = 'Maksymalny dozwolony przedział to 14 dni.';
                    submitBtn.disabled = true;
                } else {
                    infoEl.textContent = `Wybrano ${days} dni`;
                    errorEl.textContent = '';
                    submitBtn.disabled = false;
                }
            }

            const maxDate = new Date();
            maxDate.setDate(maxDate.getDate() + 45);

            const picker = new Litepicker({ 
                element: dateRangeInput,
                singleMode: false,
                allowRepick: true,
                lang: 'pl-PL',
                format: 'YYYY-MM-DD',
                delimiter: ' - ',
                minDate: Date.now(),
                maxDate: maxDate,
                maxDays: 14,
                setup: (picker) => {
                    picker.on('selected', (date1, date2) => {
                        if (date1 && date2) {
                            updateDateInfo(date1.dateInstance, date2.dateInstance);
                        }
                    });
                    picker.on('clear:selection', () => {
                        updateDateInfo(null, null);
                    });
                }
            });

            // Autocomplete dla pola miasta (wywołuje /api/geocode)
            const cityInput = document.getElementById('city-input');
            const suggestionsEl = document.getElementById('city-suggestions');
            const cityLatEl = document.getElementById('city-lat');
            const cityLonEl = document.getElementById('city-lon');

            let acTimer = null;
            function clearSuggestions(){ suggestionsEl.innerHTML=''; suggestionsEl.style.display='none'; }
            function renderSuggestions(items){
                if(!items || !items.length){ clearSuggestions(); return; }
                suggestionsEl.innerHTML = '';
                items.forEach(it => {
                    const el = document.createElement('div');
                    el.className = 'suggestion-item';
                    el.style.padding = '8px 10px';
                    el.style.cursor = 'pointer';
                    el.textContent = it.name;
                    el.dataset.lat = it.lat;
                    el.dataset.lon = it.lon;
                    el.addEventListener('click', () => {
                        cityInput.value = it.name;
                        cityLatEl.value = it.lat;
                        cityLonEl.value = it.lon;
                        clearSuggestions();
                    });
                    suggestionsEl.appendChild(el);
                });
                suggestionsEl.style.display = 'block';
            }

            cityInput && cityInput.addEventListener('input', (e)=>{
                cityLatEl.value = '';
                cityLonEl.value = '';
                const q = (e.target.value || '').trim();
                if(acTimer) clearTimeout(acTimer);
                if(!q || q.length < 2){ clearSuggestions(); return; }
                acTimer = setTimeout(()=>{
                    fetch(`/api/geocode?q=${encodeURIComponent(q)}`)
                        .then(r => r.json())
                        .then(data => renderSuggestions(data))
                        .catch(()=> clearSuggestions());
                }, 250);
            });
            document.addEventListener('click', (ev)=>{ if(!ev.target.closest('#city-suggestions') && ev.target !== cityInput) clearSuggestions(); });
        });
    </script>
{% endblock %}