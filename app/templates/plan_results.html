{% extends "base.html" %}

{% block title %}Tw√≥j plan dla: {{ plan.query.city }}{% endblock %}

{% block content %}
<div class="container-plan-results">
    
    <header class="plan-header">
        <h1>Plan podr√≥≈ºy: {{ plan.query.city }}</h1>
        <p class="subtitle">
            <span class="badge days-badge">{{ plan.query.days }} dni</span>
            <span class="badge style-badge">{{ plan.query.style }}</span>
        </p>
    </header>

    <!-- Pogoda - g√≥rna sekcja -->
 <div class="card weather-card weather-top">

        <h2><span class="icon">‚òÄÔ∏è</span> Pogoda</h2>

        <div class="weather-details">
            {% if plan.weather.daily is defined %}

            <div class="weather-carousel-wrapper">
                
                <button class="carousel-btn prev-btn" id="prevBtn" type="button">‚ùÆ</button>

                <div class="daily-weather-list" id="weatherTrack">
                    {% for day in plan.weather.daily %}
                    <div class="daily-item weather-card">

                        <div class="day-header">
                            <h3 class="date-display">{{ day.date_label or day.date }}</h3>
                        </div>
                        
                        <div class="day-icon-container">
                            <div class="weather-emoji">{{ day.icon_emoji or day.icon or 'üå§Ô∏è' }}</div>
                            <div class="weather-icon-key {% if day.icon_key %}weather-{{ day.icon_key }}{% endif %}" data-weather="{{ day.weathercode or '' }}">{{ day.opis or 'Brak danych' }}</div>
                        </div>

                        <div class="day-temp">
                            <h3>Dzie≈Ñ/Noc</h3>
                            <div>
                                <span class="temp-max">
                                {% if day.temperatura_max is defined %}{{ day.temperatura_max }}¬∞C{% else %}-{% endif %}
                                </span>
                                <span class="temp-min">
                                    {% if day.temperatura_min is defined %}{{ day.temperatura_min }}¬∞C{% else %}-{% endif %}
                                </span>
                            </div>
                        </div>

                        <div class="day-details">
                            {% if day.opad_mm is defined %}
                            <div class="detail-item">
                                <span class="detail-icon">üíß Opad:</span><strong>{{ day.opad_mm }} mm</strong>
                            </div>
                            {% endif %}
                    
                            {% if day.wiatr_kmh is defined %}
                            <div class="detail-item">
                                <span class="detail-icon">üå¨Ô∏è Wiatr:</span><strong>{{ day.wiatr_kmh }} km/h</strong>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <button class="carousel-btn next-btn" id="nextBtn" type="button">‚ùØ</button>
            </div> 

            {% else %}
                <p>Brak szczeg√≥≈Çowych danych pogodowych dla tego terminu.</p>
            {% endif %}
        </div>
    </div>

    <div class="info-grid">
        
        <div class="card budget-card">
            <h2><span class="icon">üí∞</span> Szacowany bud≈ºet</h2>
            {% if plan.cost.total_pln is not none %}
                <p class="main-cost">Ca≈Çkowity koszt: <strong>{{ plan.cost.total_pln }} PLN</strong></p>
                <p>Koszt w walucie lokalnej: {{ plan.cost.total_local }} {{ plan.cost.currency }}</p>
            {% else %}
                <p class="info-note">Dla tego miasta nie mamy jeszcze danych o szacunkowych kosztach.</p>
            {% endif %}
        </div>
    </div>
    
    <div class="attractions-section">
        <h2><span class="icon">üèõÔ∏è</span> G≈Ç√≥wne atrakcje</h2>
        {% if not is_saved %}
        <p>Kliknij na atrakcje, kt√≥re chcesz zachowaƒá w swoim planie.</p>
        {% endif %}
        
        <div class="attraction-cards">
            {% if plan.attractions and plan.attractions|length > 0 %}
                {% for attraction in plan.attractions %}
                <div class="attraction-card card">
                    <input class="card-checkbox" id="cards-{{ loop.index0 }}" name="cards" type="checkbox" value="{{ attraction.name }}" form="save-form" {% if is_saved %}disabled{% endif %}>
                    <label for="cards-{{ loop.index0 }}" class="cards-card">
                        
                        {% if attraction.photo_url %}
                        <div class="attraction-image-container">
                            <img src="{{ attraction.photo_url }}" alt="{{ attraction.name }}" class="attraction-photo" onerror="this.onerror=null;this.src='https://placehold.co/400x200/cccccc/333333?text={{ attraction.name }}';" >
                        </div>
                        {% elif attraction.icon %}
                        <div class="attraction-icon-container">
                            <img src="{{ attraction.icon }}" alt="Ikona" class="attraction-icon">
                        </div>
                        {% endif %}

                        <div class="card-header">
                            <h3 class="attraction-name">{{ attraction.name }}</h3>
                        </div>
                        
                        <div class="card-body">
                            {% if attraction.address %}
                            <p class="attraction-address">{{ attraction.address }}</p>
                            {% endif %}
                            
                            <div class="attraction-meta">
                                {% if attraction.rating %}
                                <span class="badge rating-badge">‚≠ê {{ attraction.rating }}</span>
                                {% endif %}
                                
                                {% if attraction.price_level %}
                                <span class="badge price-badge">
                                    {% for i in range(attraction.price_level) %}${% endfor %}
                                </span>
                                {% endif %}
                            </div>
                            
                            {% if attraction.types %}
                            <div class="attraction-types">
                                {% for type in attraction.types[:4] %}
                                <span class="badge type-badge" style="text-transform:capitalize;">{{ type }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </label>
                </div>
                {% endfor %}
            {% else %}
                <p>Brak danych o atrakcjach dla tego planu.</p>
            {% endif %}
        </div>
    </div>

{% if not is_saved %}
<div class="save">
    <form id="save-form" method="POST" action="{{ url_for('plans.save_plan') }}">
        <input type="hidden" name="plan_data" value='{{ plan | tojson }}'>
        <button type="submit" class="zapisz btn btn-primary"><span class="icon">üíæ</span> Zapisz plan</button>
    </form>
</div>
{% endif %}

    <div class="action-buttons">
        <button class="btn btn-secondary"><span class="icon">üìÑ</span> Pobierz jako PDF</button>
        {% if is_saved %}
        <a href="{{ url_for('main.my_plans') }}" class="btn btn-secondary">Wr√≥ƒá do listy plan√≥w</a>
        {% endif %}
    </div>
    
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const track = document.getElementById('weatherTrack');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        if (track && prevBtn && nextBtn) {
            const checkArrows = () => {
                if (track.scrollWidth <= track.clientWidth) {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                } else {
                    if (window.innerWidth > 768) {
                        prevBtn.style.display = 'flex';
                        nextBtn.style.display = 'flex';
                    }
                }
            };

            checkArrows();
            window.addEventListener('resize', checkArrows);

            const scrollAmount = 280; 

            nextBtn.addEventListener('click', () => {
                track.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            });

            prevBtn.addEventListener('click', () => {
                track.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            });
        }
    });
</script>
{% endblock %}