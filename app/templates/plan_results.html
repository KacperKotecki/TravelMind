{% extends "base.html" %}

{% block title %}Tw√≥j plan dla: {{ plan.query.city }}{% endblock %}

{% block content %}
<div class="container plan-results">
    
    <header class="plan-header">
        <h1>Plan podr√≥≈ºy: {{ plan.query.city }}</h1>
        <p class="subtitle">
            <span class="badge days-badge">{{ plan.query.days }} dni</span>
            <span class="badge style-badge">{{ plan.query.style }}</span>
        </p>
    </header>

    <!-- Pogoda - g√≥rna sekcja -->
    <div class="card weather-card weather-top">
        <h2><span class="icon">‚òÄÔ∏è</span> Pogoda</h2>
        <div class="weather-details">
                {% if plan.weather.daily is defined %}
                <div class="daily-weather-list">
                    {% for day in plan.weather.daily %}
                    <div class="daily-item card">
                        <h3>{{ day.date_label or day.date }}</h3>
                        <p><strong>
                            <!-- Zastƒôpujemy ≈Çadowanie SVG prostƒÖ emoji/ikonkƒÖ wklejonƒÖ inline -->
                            <span class="weather-emoji">{{ day.icon_emoji or day.icon or 'üå§Ô∏è' }}</span>
                            <span class="weather-icon-key {% if day.icon_key %}weather-{{ day.icon_key }}{% endif %}" data-weather="{{ day.weathercode or '' }}">{{ day.opis or 'Brak danych' }}</span>
                        </strong></p>
                        <p>Min / Max: <strong>{% if day.temperatura_min is defined %}{{ day.temperatura_min }}¬∞C{% else %}-{% endif %}</strong> / <strong>{% if day.temperatura_max is defined %}{{ day.temperatura_max }}¬∞C{% else %}-{% endif %}</strong></p>
                        {% if day.opad_mm is defined %}
                        <p>Opad: <strong>{{ day.opad_mm }} mm</strong></p>
                        {% endif %}
                        {% if day.wiatr_kmh is defined %}
                        <p>Wiatr: <strong>{{ day.wiatr_kmh }} km/h</strong></p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p>≈örednia temperatura: <strong>{{ plan.weather.temperatura }}¬∞C</strong></p>
                {% if plan.weather.temperatura_min is defined and plan.weather.temperatura_max is defined %}
                <p>Min / Max: <strong>{{ plan.weather.temperatura_min }}¬∞C</strong> / <strong>{{ plan.weather.temperatura_max }}¬∞C</strong></p>
                {% endif %}
                {% if plan.weather.wilgotnosc is defined %}
                <p>Wilgotno≈õƒá: <strong>{{ plan.weather.wilgotnosc }}%</strong></p>
                {% endif %}
                <p>Warunki: {{ plan.weather.opis }}</p>
                {% if plan.weather.wiatr_kmh is defined %}
                <p>Prƒôdko≈õƒá wiatru: {{ plan.weather.wiatr_kmh }} km/h</p>
                {% endif %}
                {% endif %}
        </div>
    </div>

    <div class="info-grid">
        
        <div class="card budget-card">
            <h2><span class="icon">üí∞</span> Szacowany bud≈ºet</h2>
            {% if plan.cost.total_pln is not none %}
                <p class="main-cost">Ca≈Çkowity koszt: <strong>{{ plan.cost.total_pln }} PLN</strong></p>
                <p>Koszt w walucie lokalnej: {{ plan.cost.total_local }} {{ plan.cost.currency }}</p>
            {% else %}
                <p class="info-note">Dla tego miasta nie mamy jeszcze danych o szacunkowych kosztach.</p>
            {% endif %}
        </div>
        
        <!-- 'Wa≈ºne obiekty' section removed as requested -->
        <div class="card nearby-card">
            <h2><span class="icon">üìç</span> Miejsca w pobli≈ºu (30 km)</h2>
            {% if plan.nearby_places and plan.nearby_places|length > 0 %}
            <ul class="nearby-list">
                {% for place in plan.nearby_places %}
                <li class="nearby-item">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                        <strong class="nearby-name">{{ place.name }}</strong>
                        {% if place.dist_km %}<span class="muted">{{ place.dist_km }} km</span>{% endif %}
                    </div>
                    {% if place.category %}
                    <div class="nearby-cat muted">{{ place.category }}</div>
                    {% endif %}
                    {% if place.address %}<div class="nearby-address">{{ place.address }}</div>{% endif %}
                    {% if place.lat is defined and place.lon is defined and place.lat and place.lon %}
                    <div style="margin-top:6px;">
                        <a class="map-link" href="https://www.openstreetmap.org/?mlat={{ place.lat }}&mlon={{ place.lon }}#map=14/{{ place.lat }}/{{ place.lon }}" target="_blank" rel="noopener">Poka≈º na mapie</a>
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="info-note">Brak danych o miejscach w pobli≈ºu lub brak klucza Geoapify.</p>
            {% endif %}
        </div>
    </div>
    
    <div class="attractions-section">
        <h2><span class="icon">üèõÔ∏è</span> G≈Ç√≥wne atrakcje</h2>
        
        <!-- Kontener na atrakcje ≈Çadowane dynamicznie -->
        <div class="attraction-cards" id="attractions-container">
            <div class="loading-spinner" style="text-align:center; padding: 2rem;">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">≈Åadowanie atrakcji...</span>
                </div>
                <p>Szukam najlepszych atrakcji...</p>
            </div>
        </div>
    </div>
<div class="save">
        <button class="zapisz btn btn-primary"><span class="icon">üíæ</span> Zapisz plan</button>
</div>

    <div class="action-buttons">
        <button class="btn btn-secondary"><span class="icon">üìÑ</span> Pobierz jako PDF</button>
    </div>
    
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const city = "{{ plan.query.city }}";
    const container = document.getElementById('attractions-container');
    
    if (!city) return;

    // Poprawiony URL: blueprint 'plans' jest zarejestrowany pod prefiksem '/plan' (liczba pojedyncza)
    fetch(`/plan/api/attractions/${encodeURIComponent(city)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('B≈ÇƒÖd sieci lub serwera');
            }
            return response.json();
        })
        .then(data => {
            container.innerHTML = ''; // Wyczy≈õƒá spinner
            
            if (data.attractions && data.attractions.length > 0) {
                data.attractions.forEach(attraction => {
                    const card = document.createElement('div');
                    card.className = 'attraction-card card';
                    
                    // Logika wy≈õwietlania obrazka: Zdjƒôcie > Ikona > Brak
                    let imageHtml = '';
                    if (attraction.photo_url) {
                        imageHtml = `<div class="attraction-image-container">
                                        <img src="${attraction.photo_url}" alt="${attraction.name}" class="attraction-photo">
                                     </div>`;
                    } else if (attraction.icon) {
                        imageHtml = `<div class="attraction-icon-container">
                                        <img src="${attraction.icon}" alt="Ikona" class="attraction-icon">
                                     </div>`;
                    }
                    
                    let ratingHtml = '';
                    if (attraction.rating) {
                        ratingHtml = `<span class="badge rating-badge">‚≠ê ${attraction.rating}</span>`;
                    }
                    
                    let priceHtml = '';
                    if (attraction.price_level) {
                        const dollars = '$'.repeat(attraction.price_level);
                        priceHtml = `<span class="badge price-badge">${dollars}</span>`;
                    }
                    
                    let typesHtml = '';
                    if (attraction.types && attraction.types.length > 0) {
                        const types = attraction.types.slice(0, 4).map(t => {
                            const cleanType = t.replace('_', ' ');
                            return `<span class="badge type-badge" style="text-transform:capitalize;">${cleanType}</span>`;
                        }).join(' ');
                        typesHtml = `<div class="attraction-types">${types}</div>`;
                    }

                    // Usuniƒôto generowanie linku do OpenStreetMap

                    card.innerHTML = `
                        ${imageHtml}
                        <div class="card-header">
                            <h3 class="attraction-name">${attraction.name}</h3>
                        </div>
                        <div class="card-body">
                            ${attraction.address ? `<p class="attraction-address">${attraction.address}</p>` : ''}
                            <div class="attraction-meta">
                                ${ratingHtml}
                                ${priceHtml}
                            </div>
                            ${typesHtml}
                        </div>
                    `;
                    container.appendChild(card);
                });
            } else {
                container.innerHTML = '<p>Brak danych o atrakcjach dla tego miasta.</p>';
            }
        })
        .catch(error => {
            console.error('B≈ÇƒÖd pobierania atrakcji:', error);
            container.innerHTML = '<p class="text-danger">Nie uda≈Ço siƒô za≈Çadowaƒá atrakcji. Spr√≥buj od≈õwie≈ºyƒá stronƒô.</p>';
        });
});
</script>
{% endblock %}