{% extends "base.html" %}

{% block title %}TwÃ³j plan dla: {{ plan.query.city }}{% endblock %}

{% block content %}
<div class="container plan-results">
    
    <header class="plan-header">
        <h1>Plan podrÃ³Å¼y: {{ plan.query.city }}</h1>
        <p class="subtitle">
            <span class="badge days-badge">{{ plan.query.days }} dni</span>
            <span class="badge style-badge">{{ plan.query.style }}</span>
        </p>
    </header>

    <!-- Pogoda - gÃ³rna sekcja -->
    <div class="card weather-card weather-top">
        <h2><span class="icon">â˜€ï¸</span> Pogoda</h2>
        <div class="weather-details">
                {% if plan.weather.daily is defined %}
                <div class="daily-weather-list">
                    {% for day in plan.weather.daily %}
                    <div class="daily-item card">
                        <h3>{{ day.date_label or day.date }}</h3>
                        <p><strong>
                            <!-- ZastÄ™pujemy Å‚adowanie SVG prostÄ… emoji/ikonkÄ… wklejonÄ… inline -->
                            <span class="weather-emoji">{{ day.icon_emoji or day.icon or 'ğŸŒ¤ï¸' }}</span>
                            <span class="weather-icon-key {% if day.icon_key %}weather-{{ day.icon_key }}{% endif %}" data-weather="{{ day.weathercode or '' }}">{{ day.opis or 'Brak danych' }}</span>
                        </strong></p>
                        <p>Min / Max: <strong>{% if day.temperatura_min is defined %}{{ day.temperatura_min }}Â°C{% else %}-{% endif %}</strong> / <strong>{% if day.temperatura_max is defined %}{{ day.temperatura_max }}Â°C{% else %}-{% endif %}</strong></p>
                        {% if day.opad_mm is defined %}
                        <p>Opad: <strong>{{ day.opad_mm }} mm</strong></p>
                        {% endif %}
                        {% if day.wiatr_kmh is defined %}
                        <p>Wiatr: <strong>{{ day.wiatr_kmh }} km/h</strong></p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p>Åšrednia temperatura: <strong>{{ plan.weather.temperatura }}Â°C</strong></p>
                {% if plan.weather.temperatura_min is defined and plan.weather.temperatura_max is defined %}
                <p>Min / Max: <strong>{{ plan.weather.temperatura_min }}Â°C</strong> / <strong>{{ plan.weather.temperatura_max }}Â°C</strong></p>
                {% endif %}
                {% if plan.weather.wilgotnosc is defined %}
                <p>WilgotnoÅ›Ä‡: <strong>{{ plan.weather.wilgotnosc }}%</strong></p>
                {% endif %}
                <p>Warunki: {{ plan.weather.opis }}</p>
                {% if plan.weather.wiatr_kmh is defined %}
                <p>PrÄ™dkoÅ›Ä‡ wiatru: {{ plan.weather.wiatr_kmh }} km/h</p>
                {% endif %}
                {% endif %}
        </div>
    </div>

    <div class="info-grid">
        
        <div class="card budget-card">
            <h2><span class="icon">ğŸ’°</span> Szacowany budÅ¼et</h2>
            {% if plan.cost.total_pln is not none %}
                <p class="main-cost">CaÅ‚kowity koszt: <strong>{{ plan.cost.total_pln }} PLN</strong></p>
                <p>Koszt w walucie lokalnej: {{ plan.cost.total_local }} {{ plan.cost.currency }}</p>
            {% else %}
                <p class="info-note">Dla tego miasta nie mamy jeszcze danych o szacunkowych kosztach.</p>
            {% endif %}
        </div>
    </div>
    
    <div class="attractions-section">
        <h2><span class="icon">ğŸ›ï¸</span> GÅ‚Ã³wne atrakcje</h2>
        
        <!-- Kontener na karty atrakcji, ktÃ³ry bÄ™dzie wypeÅ‚niany przez JS -->
        <div class="attraction-cards" id="attractions-container">
            
            <!-- Symbol Å‚adowania, ktÃ³ry zostanie zastÄ…piony przez dane -->
            <div class="loader-container">
                <p>Åadowanie atrakcji...</p>
            </div>

            <!-- Karty atrakcji zostanÄ… wstawione tutaj dynamicznie -->
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn btn-secondary"><span class="icon">ğŸ“„</span> Pobierz jako PDF</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const city = "{{ plan.query.city }}";
    const attractionsContainer = document.getElementById('attractions-container');

    // Funkcja do tworzenia pojedynczej karty atrakcji
    function createAttractionCard(attraction) {
        // Pusty szablon karty
        const card = document.createElement('div');
        card.className = 'attraction-card';

        // NagÅ‚Ã³wek z ikonÄ… i nazwÄ…
        const header = document.createElement('div');
        header.className = 'card-header';
        if (attraction.icon) {
            const icon = document.createElement('img');
            icon.src = attraction.icon;
            icon.alt = `Ikona dla ${attraction.name}`;
            icon.className = 'attraction-icon';
            header.appendChild(icon);
        }
        const name = document.createElement('h3');
        name.className = 'attraction-name';
        name.textContent = attraction.name;
        header.appendChild(name);

        // CiaÅ‚o karty z adresem, ocenÄ…, cenÄ… i typami
        const body = document.createElement('div');
        body.className = 'card-body';
        if (attraction.address) {
            const address = document.createElement('p');
            address.className = 'attraction-address';
            address.textContent = attraction.address;
            body.appendChild(address);
        }

        const meta = document.createElement('div');
        meta.className = 'attraction-meta';
        if (attraction.rating) {
            const rating = document.createElement('span');
            rating.className = 'badge rating-badge';
            rating.textContent = `â­ ${attraction.rating}`;
            meta.appendChild(rating);
        }
        if (attraction.price_level) {
            const price = document.createElement('span');
            price.className = 'badge price-badge';
            price.textContent = '$'.repeat(attraction.price_level);
            meta.appendChild(price);
        }
        body.appendChild(meta);

        if (attraction.types && attraction.types.length > 0) {
            const typesContainer = document.createElement('div');
            typesContainer.className = 'attraction-types';
            attraction.types.slice(0, 4).forEach(type => {
                const typeBadge = document.createElement('span');
                typeBadge.className = 'badge type-badge';
                typeBadge.textContent = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                typesContainer.appendChild(typeBadge);
            });
            body.appendChild(typesContainer);
        }

        card.appendChild(header);
        card.appendChild(body);
        return card;
    }

    // WywoÅ‚anie API
    fetch(`/plan/api/attractions/${city}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Problem z sieciÄ… lub serwerem.');
            }
            return response.json();
        })
        .then(data => {
            // WyczyÅ›Ä‡ kontener z komunikatu "Å‚adowanie"
            attractionsContainer.innerHTML = '';

            if (data.attractions && data.attractions.length > 0) {
                // Dodaj kaÅ¼dÄ… atrakcjÄ™ do kontenera
                data.attractions.forEach(attraction => {
                    const card = createAttractionCard(attraction);
                    attractionsContainer.appendChild(card);
                });
            } else {
                // PokaÅ¼ komunikat, jeÅ›li nie ma atrakcji
                attractionsContainer.innerHTML = '<p>Nie znaleziono atrakcji dla tego miasta.</p>';
            }
        })
        .catch(error => {
            console.error('BÅ‚Ä…d podczas pobierania atrakcji:', error);
            attractionsContainer.innerHTML = '<p class="alert alert-error">WystÄ…piÅ‚ bÅ‚Ä…d podczas Å‚adowania atrakcji. SprÃ³buj odÅ›wieÅ¼yÄ‡ stronÄ™.</p>';
        });
});
</script>
{% endblock %}